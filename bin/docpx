#!/usr/bin/env php
<?php
/**
 * Runs docpx.
 */
$usage =
"usage: docpx [-d][-h|--help] <parse_path> <output_dir>

Options
-------
  -d/--debug Turn on debug mode, generating more verbose output.
  -h/--help  Display this help message.

Examples
--------
$: docpx docpx/src docs
$: docpx -d /home/prggmr/XPSPL/src /home/prggmr/docs/XPSPL/
";

date_default_timezone_set('UTC');
array_shift($argv);
var_dump($argv);
$output = array_pop($argv);
$runfile = array_pop($argv);
// last param is file
// if - is first char ignore file
if (strpos($runfile, '-') === 0) {
    $runfile = false;
}

$options = getopt(
    'dh', ['debug', 'help']
);
// parse args and check for options
foreach ($options as $_i => $_arg) {
    // Hack
    $break = false;
    switch ($_i) {
        case 'h':
        case 'help':
            echo $usage;
            exit(0);
            break;
        case 'd':
        case 'debug':
            define('DOCPX_DEBUG', true);
            break;
        default:
            exit(sprintf(
                "Unknown option '%s'\n%s",
                $_i,
                $usage
            ));
            break;
    }
    if ($break) break;
}

$path = dirname(realpath(__FILE__));

/**
 * INCLUDE
 */
require_once $path.'/../src/const.php';
require_once $path.'/../src/logger.php';
require_once $path.'/../src/data.php';
require_once $path.'/../src/doc.php';
require_once $path.'/../src/docblock.php';
require_once $path.'/../src/token.php';
require_once $path.'/../src/tokens.php';
require_once $path.'/../src/compiler.php';
require_once $path.'/../src/writer.php';
unset($path);

if (false == $runfile) {
    \docpx\error('File/Path not received');
    exit(0);
}
if (!file_exists($runfile)) {
    \docpx\error("Could not open $runfile\n");
    exit(0);
}

$compiler = new \docpx\Compiler();
$compiler->compile($runfile);
$writer = new \docpx\Writer($compiler->getDocs());
$writer->write($output);
